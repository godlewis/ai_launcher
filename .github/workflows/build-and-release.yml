name: Build and Release Windows EXE

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build executables
      shell: powershell
      run: |
        # Create build directory
        New-Item -ItemType Directory -Force -Path build
        Set-Location build

        Write-Host "Starting build process..."

        # Check if source files exist
        if (-not (Test-Path "..\ai_launcher.cpp")) {
          Write-Host "❌ ai_launcher.cpp not found"
          exit 1
        }

        if (-not (Test-Path "..\registry_manager.cpp")) {
          Write-Host "❌ registry_manager.cpp not found"
          exit 1
        }

        Write-Host "✅ Source files found"

        # Build ai_launcher.exe (without resources for simplicity)
        Write-Host "Building ai_launcher.exe..."
        try {
          cl ..\ai_launcher.cpp /Fe:ai_launcher.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS

          if (Test-Path "ai_launcher.exe") {
            Write-Host "✅ ai_launcher.exe built successfully"
          } else {
            Write-Host "❌ ai_launcher.exe build failed"
            exit 1
          }
        } catch {
          Write-Host "❌ Error building ai_launcher.exe: $_"
          exit 1
        }

        # Build registry_manager.exe (without resources for simplicity)
        Write-Host "Building registry_manager.exe..."
        try {
          cl ..\registry_manager.cpp /Fe:registry_manager.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib advapi32.lib shlwapi.lib /SUBSYSTEM:WINDOWS

          if (Test-Path "registry_manager.exe") {
            Write-Host "✅ registry_manager.exe built successfully"
          } else {
            Write-Host "❌ registry_manager.exe build failed"
            exit 1
          }
        } catch {
          Write-Host "❌ Error building registry_manager.exe: $_"
          exit 1
        }

        # List built files
        Write-Host "Built files:"
        Get-ChildItem *.exe

        # Copy executables to root
        Copy-Item ai_launcher.exe ..\ -Force
        Copy-Item registry_manager.exe ..\ -Force

        Write-Host "✅ Build process completed successfully"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: executables
        path: |
          ai_launcher.exe
          registry_manager.exe

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          ai_launcher.exe
          registry_manager.exe
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}