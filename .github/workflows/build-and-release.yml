name: Build and Release Windows EXE

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup Windows SDK
      uses: GuillaumeFalourd/setup-windows-sdk-action@v1
      with:
        sdk-version: 22621

    - name: Add Windows SDK to PATH
      run: |
        echo "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x86" >> $env:GITHUB_PATH
        echo "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64" >> $env:GITHUB_PATH

    - name: Build ai_launcher.exe
      run: |
        mkdir build
        cd build

        # Try to find and use rc.exe from Windows SDK
        $rcPath = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\rc.exe"
        if (Test-Path $rcPath) {
            & $rcPath /fo icons.res ..\icons.rc
            cl ..\ai_launcher.cpp icons.res /Fe:ai_launcher.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
        } else {
            # Fallback: build without resources
            cl ..\ai_launcher.cpp /Fe:ai_launcher.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
        }

        # Build registry_manager.exe with same logic
        if (Test-Path $rcPath) {
            & $rcPath /fo registry_res.res ..\registry_resources.rc
            cl ..\registry_manager.cpp registry_res.res /Fe:registry_manager.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
        } else {
            cl ..\registry_manager.cpp /Fe:registry_manager.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
        }

        copy *.exe ..\

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          ai_launcher.exe
          registry_manager.exe
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
