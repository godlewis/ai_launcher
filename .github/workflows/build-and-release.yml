name: Build and Release Windows EXE

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build executables
      run: |
        mkdir build
        cd build

        Write-Host "Building ai_launcher.exe..."

        # Build ai_launcher.exe
        try {
          if (Test-Path "..\icons.rc") {
            Write-Host "Found icons.rc, compiling with resources..."
            rc /fo icons.res ..\icons.rc
            cl ..\ai_launcher.cpp icons.res /Fe:ai_launcher.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
          } else {
            Write-Host "No icons.rc found, building without resources..."
            cl ..\ai_launcher.cpp /Fe:ai_launcher.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
          }

          if (Test-Path "ai_launcher.exe") {
            Write-Host "✅ ai_launcher.exe built successfully"
          } else {
            Write-Host "❌ ai_launcher.exe build failed"
            exit 1
          }
        } catch {
          Write-Host "Error building ai_launcher.exe: $_"
          Write-Host "Trying without resources..."
          cl ..\ai_launcher.cpp /Fe:ai_launcher.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS

          if (Test-Path "ai_launcher.exe") {
            Write-Host "✅ ai_launcher.exe built successfully (without resources)"
          } else {
            Write-Host "❌ ai_launcher.exe build failed completely"
            exit 1
          }
        }

        Write-Host "Building registry_manager.exe..."

        # Build registry_manager.exe
        try {
          if (Test-Path "..\registry_resources.rc") {
            Write-Host "Found registry_resources.rc, compiling with resources..."
            rc /fo registry_res.res ..\registry_resources.rc
            cl ..\registry_manager.cpp registry_res.res /Fe:registry_manager.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
          } else {
            Write-Host "No registry_resources.rc found, building without resources..."
            cl ..\registry_manager.cpp /Fe:registry_manager.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS
          }

          if (Test-Path "registry_manager.exe") {
            Write-Host "✅ registry_manager.exe built successfully"
          } else {
            Write-Host "❌ registry_manager.exe build failed"
            exit 1
          }
        } catch {
          Write-Host "Error building registry_manager.exe: $_"
          Write-Host "Trying without resources..."
          cl ..\registry_manager.cpp /Fe:registry_manager.exe /link user32.lib gdi32.lib shell32.lib comctl32.lib /SUBSYSTEM:WINDOWS

          if (Test-Path "registry_manager.exe") {
            Write-Host "✅ registry_manager.exe built successfully (without resources)"
          } else {
            Write-Host "❌ registry_manager.exe build failed completely"
            exit 1
          }
        }

        # List built files
        Write-Host "Built files:"
        dir *.exe

        # Copy executables to root
        copy ai_launcher.exe ..\
        copy registry_manager.exe ..\

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          ai_launcher.exe
          registry_manager.exe
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
